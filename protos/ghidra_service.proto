syntax = "proto3";

package ghidra_service;

// The decompiler service definition
service DecompilerService {
  // Load a binary into the server instance
  rpc LoadBinary (LoadBinaryRequest) returns (LoadBinaryResponse);
  
  // Full analysis of a function: returns C code, Assembly, and CFG
  rpc DecompileFunction (DecompileRequest) returns (DecompileResponse);
  
  // Quick disassembly (for non-function code)
  rpc DisassembleRange (DisassembleRequest) returns (DisassembleResponse);
  
  rpc Ping (PingRequest) returns (PingResponse);
}

message LoadBinaryRequest {
  bytes binary_content = 1;
  uint64 base_address = 2;
  string arch_spec = 3; // e.g., "x86:LE:64:default"
  string sla_path = 4;
}

message LoadBinaryResponse {
  bool success = 1;
  string error_message = 2;
  repeated FunctionMeta functions = 3;
}

message DecompileRequest {
  uint64 address = 1;      // Function entry point
  bool include_asm = 2;    // Include detailed assembly/CFG?
  bool include_pcode = 3;  // Include P-code ops?
  uint32 timeout_ms = 4;
}

message DecompileResponse {
  bool success = 1;
  string error_message = 2;
  
  // High-level Result
  string c_code = 3;
  string signature = 4;
  
  // Control Flow Graph & Instructions (Bulk Data)
  repeated BasicBlock blocks = 5;
}

message BasicBlock {
  uint64 start_addr = 1;
  uint64 end_addr = 2;     // Exclusive
  uint64 id = 3;           // Block ID
  repeated uint64 out_branches = 4; // IDs of target blocks
  repeated Instruction instructions = 5;
}

message Instruction {
  uint64 address = 1;
  uint32 length = 2;
  string mnemonic = 3;
  string operands = 4;
  bytes raw_bytes = 5;
  string pcode_text = 6;   // e.g. "COPY RAM[0x10], EAX"
}

message FunctionMeta {
  uint64 address = 1;
  uint32 size = 2;
  string name = 3;
  bool is_import = 4;
}

// Legacy/Range Disassembly
message DisassembleRequest {
  uint64 address = 1;
  uint32 length = 2;
}

message DisassembleResponse {
  bool success = 1;
  repeated Instruction instructions = 2;
  string error_message = 3;
}

message PingRequest {}
message PingResponse {
  bool alive = 1;
}
